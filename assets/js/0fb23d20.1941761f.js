"use strict";(self.webpackChunkregardsoss_github_io=self.webpackChunkregardsoss_github_io||[]).push([[38754],{59047:(e,r,s)=>{s.r(r),s.d(r,{assets:()=>d,contentTitle:()=>i,default:()=>h,frontMatter:()=>t,metadata:()=>a,toc:()=>l});var n=s(74848),o=s(28453);const t={id:"backend-order-architecture",title:"How it works",sidebar_label:"How it works",slug:"/development/backend/services/order/architecture/",sidebar_position:2},i=void 0,a={id:"development/services/order/backend-order-architecture",title:"How it works",description:"Introduction",source:"@site/versioned_docs/version-2.0.0/development/services/order/conception.md",sourceDirName:"development/services/order",slug:"/development/backend/services/order/architecture/",permalink:"/docs/development/backend/services/order/architecture/",draft:!1,unlisted:!1,editUrl:"https://github.com/RegardsOss/RegardsOss.github.io/edit/master/versioned_docs/version-2.0.0/development/services/order/conception.md",tags:[],version:"2.0.0",sidebarPosition:2,frontMatter:{id:"backend-order-architecture",title:"How it works",sidebar_label:"How it works",slug:"/development/backend/services/order/architecture/",sidebar_position:2},sidebar:"dev",previous:{title:"Overview",permalink:"/docs/development/backend/services/order/overview/"},next:{title:"Create Order",permalink:"/docs/development/backend/services/order/guides/create-order-amqp"}},d={},l=[{value:"Introduction",id:"introduction",level:2},{value:"Basket",id:"basket",level:2},{value:"Additional dataset data",id:"additional-dataset-data",level:3},{value:"Order creation",id:"order-creation",level:2},{value:"Suborders creation",id:"suborders-creation",level:2},{value:"Suborder workflow",id:"suborder-workflow",level:2},{value:"Storage job details",id:"storage-job-details",level:2},{value:"Order final state",id:"order-final-state",level:2},{value:"Other Order states",id:"other-order-states",level:2},{value:"Processing selection",id:"processing-selection",level:2},{value:"Order states workflow",id:"order-states-workflow",level:2}];function c(e){const r={a:"a",admonition:"admonition",em:"em",h2:"h2",h3:"h3",img:"img",li:"li",p:"p",strong:"strong",ul:"ul",...(0,o.R)(),...e.components};return(0,n.jsxs)(n.Fragment,{children:[(0,n.jsx)(r.h2,{id:"introduction",children:"Introduction"}),"\n",(0,n.jsx)(r.p,{children:"This page describes how the rs-order microservice works."}),"\n",(0,n.jsxs)(r.p,{children:["You can find a ",(0,n.jsx)(r.a,{href:"/docs/user-guide/order-data/introduction/",children:"user guide here"})," to understand how to\nuse and manage orders through UI."]}),"\n",(0,n.jsx)(r.h2,{id:"basket",children:"Basket"}),"\n",(0,n.jsxs)(r.p,{children:["In the REGARDS UI, an authenticated user can explore the ",(0,n.jsx)(r.a,{href:"/docs/development/concepts/products/",children:"products"})," list.\nThese products are provided by ",(0,n.jsx)(r.a,{href:"/docs/development/backend/services/catalog/overview/",children:"rs-catalog"}),". Searching products is possible using\nthe ",(0,n.jsx)(r.a,{href:"../catalog/overview#how-to-use",children:"API"}),"."]}),"\n",(0,n.jsxs)(r.p,{children:["The REGARDS Basket is simply a selection of downloadable products. REGARDS will try to download these products\nonce the user start an order. The products selection can be done with\nthis ",(0,n.jsx)(r.a,{href:"/docs/development/backend/services/order/api-swagger#tag/basket-controller/operation/addSelection",children:"API"}),", another way is to\nprovide a file containing all the products identifiers (\nsee ",(0,n.jsx)(r.a,{href:"/docs/development/backend/services/order/api-swagger#tag/basket-controller/operation/addSelectionFromFile",children:"API"}),"). ",(0,n.jsx)(r.a,{href:"/docs/development/backend/services/order/guides/fill-basket-from-file",children:"Learn more"}),"."]}),"\n",(0,n.jsx)(r.admonition,{title:"public data",type:"info",children:(0,n.jsx)(r.p,{children:"Note that some data can be accessed without authentication, but cannot be added to a basket. You have to be logged to\nhave\na basket.\nA user can only have one basket."})}),"\n",(0,n.jsx)(r.h3,{id:"additional-dataset-data",children:"Additional dataset data"}),"\n",(0,n.jsx)(r.p,{children:"Files are associated with a product, and they are not accessible independently.\nProducts must be linked to a dataset to be accessible to users. (See rs-dam microservice)\nHowever, sometimes there are files associated to a dataset, typically containing metadata or descriptions of the\ndataset."}),"\n",(0,n.jsx)(r.p,{children:"Data type files (RAWDATA) associated with datasets are automatically downloaded when the basket contains a product from that dataset."}),"\n",(0,n.jsx)(r.h2,{id:"order-creation",children:"Order creation"}),"\n",(0,n.jsxs)(r.p,{children:["Once the user has added at least one product to his basket (or cart), an order can be initiated. This order is created\nwith ",(0,n.jsx)(r.strong,{children:"PENDING"})," state. REGARDS will then attempt to retrieve all the files related to the selected\nproducts. (",(0,n.jsx)(r.a,{href:"/docs/development/backend/services/order/guides/create-order-rest",children:"See API Guide"}),")"]}),"\n",(0,n.jsx)(r.h2,{id:"suborders-creation",children:"Suborders creation"}),"\n",(0,n.jsxs)(r.p,{children:["To retrieve files, rs-order will create several jobs. These jobs are called ",(0,n.jsx)(r.strong,{children:"suborders"}),". A suborder has :"]}),"\n",(0,n.jsxs)(r.ul,{children:["\n",(0,n.jsxs)(r.li,{children:["a limited size in bytes (see ",(0,n.jsx)(r.a,{href:"/docs/development/backend/services/order/configuration/static-configuration",children:"configuration"}),"),"]}),"\n",(0,n.jsx)(r.li,{children:"a limited number of files (5000, not configurable)"}),"\n"]}),"\n",(0,n.jsx)(r.p,{children:"That's why several suborders can be required for one order. These jobs will"}),"\n",(0,n.jsxs)(r.ul,{children:["\n",(0,n.jsxs)(r.li,{children:["query the ",(0,n.jsx)(r.a,{href:"/docs/development/backend/services/storage/overview/",children:"rs-storage service"})," for files stored by REGARDS. They are the ",(0,n.jsx)(r.strong,{children:"Storage Jobs"}),",\nthat try to restore or make files available, by querying the storage service."]}),"\n",(0,n.jsxs)(r.li,{children:["get all externally stored files. These are the ",(0,n.jsx)(r.strong,{children:"External Jobs"})]}),"\n"]}),"\n",(0,n.jsx)(r.admonition,{title:"external or internal file ?",type:"note",children:(0,n.jsxs)(r.ul,{children:["\n",(0,n.jsx)(r.li,{children:"External file : A file not managed by REGARDS. REGARDS got only a reference (an url) to this file."}),"\n",(0,n.jsx)(r.li,{children:"Internal file : stored by REGARDS in one of the configured storage."}),"\n"]})}),"\n",(0,n.jsxs)(r.admonition,{title:"user quotas",type:"important",children:[(0,n.jsx)(r.p,{children:"Quotas are used only for files stored by REGARDS. Externally stored files don't require a quota, but do require access\nrights."}),(0,n.jsx)(r.p,{children:"REGARDS will retrieve files until all files have been retrieved or the user's download quota has been reached."})]}),"\n",(0,n.jsxs)(r.p,{children:["Once all jobs are created, the order state transitions to ",(0,n.jsx)(r.strong,{children:"RUNNING"}),". While the jobs are still running, the order\nremains in the ",(0,n.jsx)(r.strong,{children:"RUNNING"})," state."]}),"\n",(0,n.jsx)(r.h2,{id:"suborder-workflow",children:"Suborder workflow"}),"\n",(0,n.jsxs)(r.p,{children:["There is a maximum number of running storage jobs for a given user (external jobs are not concerned by this limit).\nThis number is defined in the service configuration (",(0,n.jsx)(r.em,{children:"regards.order.max.storage.files.jobs.per.user"}),")."]}),"\n",(0,n.jsx)(r.p,{children:"A sub-order is considered as finished once data has been retrieved from rs-storage, and downloaded by the user. That's why an order can be blocked, until the user does a download of the order. The download of an order downloads all data retrieve from rs-storage, and launch remaining sub-orders. In case of big order, multiple download can be required."}),"\n",(0,n.jsxs)(r.p,{children:["This download can be done on UI or API. See the dedicated ",(0,n.jsx)(r.a,{href:"/docs/development/backend/services/order/guides/download-ordered-files",children:"API guide"})]}),"\n",(0,n.jsx)(r.h2,{id:"storage-job-details",children:"Storage job details"}),"\n",(0,n.jsxs)(r.p,{children:["In fact, storage jobs ask the storage service to make files available for download. There is no download by REGARDS in\nthis operation. To learn more, read the nearline ",(0,n.jsx)(r.a,{href:"/docs/development/backend/services/storage/overview/",children:"storage documentation"}),". The download operation\nis done by the user."]}),"\n",(0,n.jsxs)(r.p,{children:["The maximum number of parallel job (pool size) is defined in the service configuration (",(0,n.jsx)(r.em,{children:"regards.jobs.pool.size"}),"). This\npool is shared by all users of the rs-order microservice."]}),"\n",(0,n.jsxs)(r.p,{children:["When a sub-order is finished (all files retrieved by storage service during the job and all files are downloaded by\nuser), rs-order try to launch another sub-order and the associated ",(0,n.jsx)(r.strong,{children:"Storage job"}),"."]}),"\n",(0,n.jsx)(r.admonition,{type:"note",children:(0,n.jsx)(r.p,{children:"In case of error inside the Storage job, only the sub-order fail. Other storage jobs may continue."})}),"\n",(0,n.jsx)(r.admonition,{title:"prioritization",type:"info",children:(0,n.jsx)(r.p,{children:"The storage jobs are prioritized among all users based on suborder size: smaller suborders are given priority"})}),"\n",(0,n.jsx)(r.admonition,{title:"sub-order number limit",type:"warning",children:(0,n.jsxs)(r.ul,{children:["\n",(0,n.jsxs)(r.li,{children:["Globally : REGARDS cannot launch more than X sub-order in parallel. (X is the jobs pool size,\n",(0,n.jsx)(r.em,{children:"regards.jobs.pool.size"}),")"]}),"\n",(0,n.jsxs)(r.li,{children:["Per user : A user cannot have more than Y waiting sub-order. That means sub-orders that are finished but not\ndownloaded. (Y is ",(0,n.jsx)(r.em,{children:"regards.order.max.storage.files.jobs.per.user"}),")"]}),"\n"]})}),"\n",(0,n.jsx)(r.h2,{id:"order-final-state",children:"Order final state"}),"\n",(0,n.jsx)(r.p,{children:"Once all sub-orders are finished, order can be in multiple states :"}),"\n",(0,n.jsxs)(r.ul,{children:["\n",(0,n.jsx)(r.li,{children:"FAILED : No data file is available (nothing to download)"}),"\n",(0,n.jsx)(r.li,{children:"DONE_WITH_WARNING : One or more data files have failed but at least one is available"}),"\n",(0,n.jsx)(r.li,{children:"DONE : All data files are available"}),"\n"]}),"\n",(0,n.jsx)(r.h2,{id:"other-order-states",children:"Other Order states"}),"\n",(0,n.jsxs)(r.ul,{children:["\n",(0,n.jsx)(r.li,{children:"PENDING : Order is in creation, no associated jobs exist or are planned to be executed"}),"\n",(0,n.jsx)(r.li,{children:"RUNNING : At least one associated job is planned to be executed"}),"\n",(0,n.jsx)(r.li,{children:"PAUSED : Associated jobs are asked to be stopped (or already stopped). Order can be resumed later"}),"\n",(0,n.jsxs)(r.li,{children:["EXPIRED : Order has been detected as expired and will be paused soon (Duration is configurable through\nUI, ",(0,n.jsx)(r.a,{href:"/docs/development/backend/services/order/configuration/static-configuration",children:"see here"}),")"]}),"\n"]}),"\n",(0,n.jsx)(r.h2,{id:"processing-selection",children:"Processing selection"}),"\n",(0,n.jsxs)(r.p,{children:["Some processing treatments can be selected at the basket level, either through the API or in the user interface.\nProcessing treatments are applied to all files ordered within the same dataset. If a processing treatment is selected, a\nprocessing job is created after the ",(0,n.jsx)(r.a,{href:"#storage-job-details",children:"storage job"}),"."]}),"\n",(0,n.jsxs)(r.p,{children:["You can learn more in the ",(0,n.jsx)(r.a,{href:"/docs/development/backend/services/processing/overview/",children:"processing microservice section"})]}),"\n",(0,n.jsx)(r.h2,{id:"order-states-workflow",children:"Order states workflow"}),"\n",(0,n.jsx)(r.p,{children:"Here under is the state diagram of the order process :"}),"\n",(0,n.jsx)(r.p,{children:(0,n.jsx)(r.img,{src:s(51956).A+"",width:"950",height:"780"})})]})}function h(e={}){const{wrapper:r}={...(0,o.R)(),...e.components};return r?(0,n.jsx)(r,{...e,children:(0,n.jsx)(c,{...e})}):c(e)}},51956:(e,r,s)=>{s.d(r,{A:()=>n});const n=s.p+"assets/images/ord_state_diagram-753c50ae0d1f3441bf8096f7a33c0f83.png"},28453:(e,r,s)=>{s.d(r,{R:()=>i,x:()=>a});var n=s(96540);const o={},t=n.createContext(o);function i(e){const r=n.useContext(t);return n.useMemo((function(){return"function"==typeof e?e(r):{...r,...e}}),[r,e])}function a(e){let r;return r=e.disableParentContext?"function"==typeof e.components?e.components(o):e.components||o:i(e.components),n.createElement(t.Provider,{value:r},e.children)}}}]);