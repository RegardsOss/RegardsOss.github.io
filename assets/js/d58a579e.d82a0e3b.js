"use strict";(self.webpackChunkregardsoss_github_io=self.webpackChunkregardsoss_github_io||[]).push([[86737],{52114:(e,n,t)=>{t.r(n),t.d(n,{assets:()=>d,contentTitle:()=>a,default:()=>u,frontMatter:()=>s,metadata:()=>o,toc:()=>l});var r=t(74848),i=t(28453);const s={id:"rabbitmq",title:"RabbitMQ",slug:"/setup/swarm/advanced/rabbitmq/",sidebar_position:5},a=void 0,o={id:"setup/swarm/advanced/rabbitmq",title:"RabbitMQ",description:"This guide allows you to configure the mandatory RabbitMQ server deployed with your Regards swarm stack.",source:"@site/docs/setup/swarm/advanced/swarm-rabbitmq.md",sourceDirName:"setup/swarm/advanced",slug:"/setup/swarm/advanced/rabbitmq/",permalink:"/docs/next/setup/swarm/advanced/rabbitmq/",draft:!1,unlisted:!1,editUrl:"https://github.com/RegardsOss/RegardsOss.github.io/edit/master/docs/setup/swarm/advanced/swarm-rabbitmq.md",tags:[],version:"current",sidebarPosition:5,frontMatter:{id:"rabbitmq",title:"RabbitMQ",slug:"/setup/swarm/advanced/rabbitmq/",sidebar_position:5},sidebar:"install",previous:{title:"Posgres database",permalink:"/docs/next/setup/swarm/advanced/postgres-database/"},next:{title:"MinIO",permalink:"/docs/next/setup/swarm/advanced/minio/"}},d={},l=[{value:"Cluster configuration",id:"cluster-configuration",level:2},{value:"Client port configuration",id:"client-port-configuration",level:2},{value:"No TLS (unsafe)",id:"no-tls-unsafe",level:3},{value:"With TLS",id:"with-tls",level:3},{value:"Admin port configuration",id:"admin-port-configuration",level:2},{value:"No TLS (unsafe)",id:"no-tls-unsafe-1",level:3},{value:"With TLS",id:"with-tls-1",level:3},{value:"Configure admin",id:"configure-admin",level:2},{value:"Configure users",id:"configure-users",level:2},{value:"Configure shovels",id:"configure-shovels",level:2},{value:"Create queues, exchanges and bindings",id:"create-queues-exchanges-and-bindings",level:2},{value:"Consumer timeout",id:"consumer-timeout",level:3},{value:"Mutualised RabbitMQ",id:"mutualised-rabbitmq",level:3}];function c(e){const n={a:"a",admonition:"admonition",br:"br",code:"code",h2:"h2",h3:"h3",li:"li",p:"p",pre:"pre",ul:"ul",...(0,i.R)(),...e.components};return(0,r.jsxs)(r.Fragment,{children:[(0,r.jsx)(n.p,{children:"This guide allows you to configure the mandatory RabbitMQ server deployed with your Regards swarm stack."}),"\n",(0,r.jsx)(n.admonition,{title:"RabbitMQ Configuration",type:"info",children:(0,r.jsxs)(n.p,{children:["Edit your inventory file ",(0,r.jsx)(n.code,{children:"inventories/<your inventory>/group_vars/regards_nodes/main.yml"})," to override RabbitMQ\ninformation"]})}),"\n",(0,r.jsx)(n.admonition,{title:"Format used",type:"info",children:(0,r.jsxs)(n.p,{children:["The REGARDS playbooks generates a definition file that is imported by the RabbitMQ\nservice. ",(0,r.jsx)(n.a,{href:"https://www.rabbitmq.com/docs/definitions",children:"Click here to get more info about this format"}),"."]})}),"\n",(0,r.jsx)(n.admonition,{title:"RabbitMQ updates and reboots",type:"danger",children:(0,r.jsx)(n.p,{children:"Every time you change the RabbitMQ configuration inside your inventory, you must shutdown REGARDS before running the\nplaybook to deploy the changes."})}),"\n",(0,r.jsx)(n.h2,{id:"cluster-configuration",children:"Cluster configuration"}),"\n",(0,r.jsxs)(n.p,{children:["To deploy a cluster of RabbitMQ nodes, you need to set ",(0,r.jsx)(n.code,{children:"global_service"})," to ",(0,r.jsx)(n.code,{children:"true"}),":"]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-yaml",children:"group_docker_cots:\n  rabbitmq:\n    global_service: true\n"})}),"\n",(0,r.jsx)(n.p,{children:"If you don't want all your Swarm nodes to receive a RabbitMQ replica, use Swarm label node placement constraint:"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-yaml",children:"group_docker_cots:\n  rabbitmq:\n    global_service: true\n    node_label_placement_constraint:\n      key: type\n      value: cots\n"})}),"\n",(0,r.jsxs)(n.p,{children:["This example tells Swarm to deploy a replica of RabbitMQ on every node having a property ",(0,r.jsx)(n.code,{children:"type"})," valued to ",(0,r.jsx)(n.code,{children:"cots"}),"."]}),"\n",(0,r.jsx)(n.h2,{id:"client-port-configuration",children:"Client port configuration"}),"\n",(0,r.jsx)(n.p,{children:"Client configuration allows external programs to contact the RabbitMQ server deployed."}),"\n",(0,r.jsx)(n.h3,{id:"no-tls-unsafe",children:"No TLS (unsafe)"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-yaml",children:"group_docker_cots:\n  rabbitmq:\n    # Port to connect to RabbitMQ server\n    client: 5672\n"})}),"\n",(0,r.jsx)(n.h3,{id:"with-tls",children:"With TLS"}),"\n",(0,r.jsxs)(n.p,{children:["To enable ssl on your RabbitMQ server, you need define the port (using ",(0,r.jsx)(n.code,{children:"client_ssl"})," property):"]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-yaml",children:"group_docker_cots:\n  rabbitmq:\n    # Port to connect to RabbitMQ server\n    client: 5672\n    # Port to connect to RabbitMQ server with ssl\n    client_ssl: 5671\n"})}),"\n",(0,r.jsx)(n.p,{children:"And you need to provide SSL certificates names inside your inventory:"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-yaml",metastring:'title="Certificates used by RabbitMQ"',children:"group_docker_cots_configuration:\n  rabbitmq:\n    ssl:\n      crt: certificate.crt\n      key: certificate.key\n      ca: certificate.ca.crt\n"})}),"\n",(0,r.jsx)(n.admonition,{title:"Certificates location",type:"info",children:(0,r.jsxs)(n.p,{children:["Certificate files must be located inside ",(0,r.jsx)(n.code,{children:"<my-inventory>/static/ssl/"})," folder in your inventory.",(0,r.jsx)(n.br,{}),"\n","In upper example, it means the file ",(0,r.jsx)(n.code,{children:"<my-inventory>/static/ssl/certificate.crt"})," exists."]})}),"\n",(0,r.jsx)(n.h2,{id:"admin-port-configuration",children:"Admin port configuration"}),"\n",(0,r.jsx)(n.p,{children:"Our playbook let you configure the port used to administrate RabbitMQ using a browser."}),"\n",(0,r.jsx)(n.h3,{id:"no-tls-unsafe-1",children:"No TLS (unsafe)"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-yaml",children:"group_docker_cots:\n  rabbitmq:\n    # Port to connect to RabbitMQ admin dashboard\n    http: 15672\n"})}),"\n",(0,r.jsx)(n.h3,{id:"with-tls-1",children:"With TLS"}),"\n",(0,r.jsx)(n.p,{children:"On REGARDS Swarm deployment, it's the rs-front service that provides the RabbitMQ Admin UI through TLS."}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-yaml",children:"group_docker_mservices:\n  front:\n    rabbitmq_admin: 15672\n\n\ngroup_docker_cots:\n  rabbitmq:\n  # rabbitmq admin HMI is open through rs-front, no property used here\n"})}),"\n",(0,r.jsx)(n.h2,{id:"configure-admin",children:"Configure admin"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-yaml",children:'group_docker_cots:\n  rabbitmq:\n    # Administrator user name for RabbitMQ Server\n    user: my-admin\n    # Administrator user password for RabbitMQ Server \n    # password is saved inside the Vault file\n    password: "{{ regards_vault.group_docker_cots.rabbitmq.regards.password }}"\n\ngroup_config_mservices:\n  amqp:\n    user: "{{ group_docker_cots.rabbitmq.user }}"\n    password: "{{ group_docker_cots.rabbitmq.password }}"\n'})}),"\n",(0,r.jsx)(n.admonition,{type:"note",children:(0,r.jsxs)(n.p,{children:["If you do not override this property, admin will be the default RabbitMQ administrator ",(0,r.jsx)(n.code,{children:"guest"}),".",(0,r.jsx)(n.br,{}),"\n","If you override the administrator name, user ",(0,r.jsx)(n.code,{children:"guest"})," is not allowed"]})}),"\n",(0,r.jsx)(n.h2,{id:"configure-users",children:"Configure users"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-yaml",children:"group_docker_cots:\n  rabbitmq:\n    # RabbitMQ configuration to automatically create users\n    additional_users:\n      - name: exemple-user\n        password: XXXXX\n        tags: ''\n    # RabbitMQ configuration to automatically create users permissions \n    user_permissions:\n      - user: exemple-user\n        vhost: regards.multitenant.manager\n        configure: ''\n        write: ''\n        read: ''\n"})}),"\n",(0,r.jsx)(n.h2,{id:"configure-shovels",children:"Configure shovels"}),"\n",(0,r.jsx)(n.p,{children:"Our playbook provides following configuration to automatically create shovels"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-yaml",children:"group_docker_cots:\n  rabbitmq:\n    additional_parameters:\n      - component: shovel\n        name: Exemple shovel\n        vhost: regards.multitenant.manager\n        value:\n          ack-mode: on-confirm\n          dest-add-forward-headers: false\n          dest-protocol: amqp091\n          dest-exchange: exemple.exchange\n          dest-uri: amqp:///regards.multitenant.manager\n          src-delete-after: never\n          src-protocol: amqp091\n          src-queue: source.queue\n          src-uri: amqp://user:password@other-amqp-server-adress:5672/vhost\n"})}),"\n",(0,r.jsx)(n.admonition,{title:"Shovels",type:"info",children:(0,r.jsx)(n.p,{children:"Most of the time, a shovel takes messages from a distant queue and put them in a local exchange"})}),"\n",(0,r.jsx)(n.h2,{id:"create-queues-exchanges-and-bindings",children:"Create queues, exchanges and bindings"}),"\n",(0,r.jsx)(n.p,{children:"Our playbook provides three different properties to automatically create RabbitMQ queues, exchanges and bindings:"}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.code,{children:"additional_queues"})," property to manage queues"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.code,{children:"additional_exchanges"})," property to manage exchanges"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.code,{children:"additional_bindings"})," property to manage bindings"]}),"\n"]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-yaml",children:"group_docker_cots:\n  rabbitmq:\n    additional_exchanges:\n      - name: exemple.exchange\n        vhost: regards.multitenant.manager\n        # type can be Direct / Fanout / Topic\n        type: fanout\n        durable: true\n        internal: false\n    additional_queues:\n      - name: exemple.queue\n        vhost: regards.multitenant.manager\n        durable: true\n        auto_delete: false\n        arguments:\n          x-dead-letter-exchange: regards.DLX\n          x-dead-letter-routing-key: regards.DLQ\n          x-max-priority: 255\n    additional_bindings:\n      - source: exemple.exchange\n        vhost: regards.multitenant.manager\n        destination: exemple.queue\n        destination_type: queue\n        routing_key: 'exemple'\n"})}),"\n",(0,r.jsx)(n.h3,{id:"consumer-timeout",children:"Consumer timeout"}),"\n",(0,r.jsxs)(n.p,{children:["Our playbook provides following configuration to override default consumer timeout, which is by default ",(0,r.jsx)(n.code,{children:"30 min"}),"."]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-yaml",children:"group_docker_cots:\n  rabbitmq:\n    consumer_timeout_in_ms: 3600000\n    # set to 1h\n"})}),"\n",(0,r.jsx)(n.h3,{id:"mutualised-rabbitmq",children:"Mutualised RabbitMQ"}),"\n",(0,r.jsxs)(n.p,{children:["If you prefer to use a mutualised instance of RabbitMQ, ensure it\nuses ",(0,r.jsx)(n.a,{href:"/docs/next/setup/swarm/cots-version/",children:"the right version of RabbitMQ"})," and plugin ",(0,r.jsx)(n.code,{children:"rabbitmq_delayed_message_exchange"})," is active"]})]})}function u(e={}){const{wrapper:n}={...(0,i.R)(),...e.components};return n?(0,r.jsx)(n,{...e,children:(0,r.jsx)(c,{...e})}):c(e)}},28453:(e,n,t)=>{t.d(n,{R:()=>a,x:()=>o});var r=t(96540);const i={},s=r.createContext(i);function a(e){const n=r.useContext(s);return r.useMemo((function(){return"function"==typeof e?e(n):{...n,...e}}),[n,e])}function o(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(i):e.components||i:a(e.components),r.createElement(s.Provider,{value:n},e.children)}}}]);