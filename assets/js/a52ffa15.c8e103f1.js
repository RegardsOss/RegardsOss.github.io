"use strict";(self.webpackChunkregardsoss_github_io=self.webpackChunkregardsoss_github_io||[]).push([[17104],{83183:(e,t,n)=>{n.r(t),n.d(t,{assets:()=>c,contentTitle:()=>s,default:()=>p,frontMatter:()=>a,metadata:()=>i,toc:()=>d});var o=n(74848),r=n(28453);const a={id:"2.2-to-2.3",title:"V2.2 to V2.3",slug:"/setup/swarm/migration/2.2-to-2.3",sidebar_position:8},s=void 0,i={id:"setup/swarm/migration/2.2-to-2.3",title:"V2.2 to V2.3",description:"Steps to migrate REGARDS from version 2.2 to 2.3",source:"@site/docs/setup/swarm/migration/2.2-to-2.3.md",sourceDirName:"setup/swarm/migration",slug:"/setup/swarm/migration/2.2-to-2.3",permalink:"/docs/next/setup/swarm/migration/2.2-to-2.3",draft:!1,unlisted:!1,editUrl:"https://github.com/RegardsOss/RegardsOss.github.io/edit/master/docs/setup/swarm/migration/2.2-to-2.3.md",tags:[],version:"current",sidebarPosition:8,frontMatter:{id:"2.2-to-2.3",title:"V2.2 to V2.3",slug:"/setup/swarm/migration/2.2-to-2.3",sidebar_position:8},sidebar:"install",previous:{title:"V2.0 to V2.1",permalink:"/docs/next/setup/swarm/migration/2.0-to-2.1"},next:{title:"CoTS Versions",permalink:"/docs/next/setup/swarm/cots-version/"}},c={},d=[{value:"Database modifications",id:"database-modifications",level:2}];function l(e){const t={a:"a",code:"code",h2:"h2",p:"p",pre:"pre",...(0,r.R)(),...e.components};return(0,o.jsxs)(o.Fragment,{children:[(0,o.jsx)(t.p,{children:"Steps to migrate REGARDS from version 2.2 to 2.3"}),"\n",(0,o.jsx)(t.h2,{id:"database-modifications",children:"Database modifications"}),"\n",(0,o.jsxs)(t.p,{children:["In version 2.3, several changes were made to the tables ",(0,o.jsx)(t.code,{children:"ingest.t_aip"})," and ",(0,o.jsx)(t.code,{children:"fem.t_feature"})," (see the\n",(0,o.jsx)(t.a,{href:"../../../../../release-notes/v2.3.0#database",children:"release note"})," for more information)."]}),"\n",(0,o.jsxs)(t.p,{children:["Although these changes are automatically applied when launching the new version of the server, they may take several\nminutes or even hours, depending on the number of projects and the volume of products. The migration may involve\nseveral restarts of the microservice ",(0,o.jsx)(t.code,{children:"rs-ingest"})," and ",(0,o.jsx)(t.code,{children:"rs-fem"}),"."]}),"\n",(0,o.jsx)(t.p,{children:"Therefore, it is highly recommended for projects with a large set of OAIS or GeoGson products (over 100k products) to\nrun the following migration SQL script separately after having shut down the server and before deploying the new\nversion."}),"\n",(0,o.jsx)(t.pre,{children:(0,o.jsx)(t.code,{className:"language-postgresql",children:"ALTER TABLE ingest.t_aip\n    ADD COLUMN IF NOT EXISTS category varchar(128);\n\nALTER TABLE ingest.t_sip\n    ADD COLUMN IF NOT EXISTS category varchar(128);\n\nDROP INDEX IF EXISTS ingest.idx_aip_categories;\n\nCREATE OR REPLACE PROCEDURE update_categories(tablename TEXT)\nLANGUAGE plpgsql\nAS $$\nDECLARE\n    start_time TIMESTAMP := clock_timestamp();\n    total_duration INTERVAL;\n    row_count INTEGER := 0;\n    total_row_count INTEGER := 0;\nBEGIN\n    RAISE NOTICE 'Migrating % table...', tablename;\n    start_time := clock_timestamp();\n    LOOP\n        EXECUTE format('\n            WITH cte AS (\n                SELECT id\n                FROM ingest.%1$I\n                WHERE category IS NULL AND jsonb_typeof(categories) = ''array'' AND jsonb_array_length(categories) > 0\n                LIMIT 2000\n                FOR UPDATE SKIP LOCKED\n            )\n            UPDATE ingest.%1$I product\n            SET category = categories ->> 0\n            FROM cte\n            WHERE product.id = cte.id;', tablename);\n        GET DIAGNOSTICS row_count = ROW_COUNT;\n        total_row_count := total_row_count + row_count;\n        EXIT WHEN NOT FOUND;\n        COMMIT;\n        total_duration := clock_timestamp() - start_time;\n        RAISE NOTICE '% rows updated (average: % rows/s)', total_row_count, (total_row_count /\n              (SELECT extract ('epoch' from total_duration)));\n    END LOOP;\n    RAISE NOTICE 'Migration of % table complete.', tablename;\nEND\n$$;\n\nCALL update_categories('t_aip');\nCALL update_categories('t_sip');\n\nDROP PROCEDURE update_categories;\n\nCREATE INDEX IF NOT EXISTS idx_aip_category ON ingest.t_aip USING btree (category);\n\nCREATE INDEX IF NOT EXISTS idx_aip_last_update_id ON ingest.t_aip USING btree (last_update, id);\n\nDROP INDEX IF EXISTS idx_feature_model_last_update;\nCREATE INDEX IF NOT EXISTS idx_feature_model_last_update_id ON fem.t_feature USING btree (model, last_update, id);\n\nDO $$ BEGIN RAISE NOTICE 'Migration for REGARDS 2.3.0 complete.'; END $$;\n"})}),"\n",(0,o.jsx)(t.p,{children:"This script can be run with a psql client, on each database used by a REGARDS tenant:"}),"\n",(0,o.jsx)(t.pre,{children:(0,o.jsx)(t.code,{children:"psql -h db_host -d db_name -U db_user < migration2.3.sql\n"})}),"\n",(0,o.jsx)(t.p,{children:"If this script is interrupted for any reason (a network issue for instance), just relaunch it and it will continue\nthe migration. Its full completion is confirmed by the message:"}),"\n",(0,o.jsx)(t.pre,{children:(0,o.jsx)(t.code,{children:"NOTICE:  Migration for REGARDS 2.3.0 complete.\n"})})]})}function p(e={}){const{wrapper:t}={...(0,r.R)(),...e.components};return t?(0,o.jsx)(t,{...e,children:(0,o.jsx)(l,{...e})}):l(e)}},28453:(e,t,n)=>{n.d(t,{R:()=>s,x:()=>i});var o=n(96540);const r={},a=o.createContext(r);function s(e){const t=o.useContext(a);return o.useMemo((function(){return"function"==typeof e?e(t):{...t,...e}}),[t,e])}function i(e){let t;return t=e.disableParentContext?"function"==typeof e.components?e.components(r):e.components||r:s(e.components),o.createElement(a.Provider,{value:t},e.children)}}}]);