"use strict";(self.webpackChunkregardsoss_github_io=self.webpackChunkregardsoss_github_io||[]).push([[66751],{73687:(e,n,t)=>{t.r(n),t.d(n,{assets:()=>d,contentTitle:()=>o,default:()=>u,frontMatter:()=>a,metadata:()=>r,toc:()=>c});var i=t(74848),s=t(28453);const a={id:"2.0-to-2.1",title:"V2.0 to V2.1",slug:"/setup/swarm/migration/2.0-to-2.1",sidebar_position:7},o=void 0,r={id:"setup/swarm/migration/2.0-to-2.1",title:"V2.0 to V2.1",description:"Steps to migrate REGARDS from version 2.0 to 2.1",source:"@site/docs/setup/swarm/migration/2.0-to-2.1.md",sourceDirName:"setup/swarm/migration",slug:"/setup/swarm/migration/2.0-to-2.1",permalink:"/docs/next/setup/swarm/migration/2.0-to-2.1",draft:!1,unlisted:!1,editUrl:"https://github.com/RegardsOss/RegardsOss.github.io/edit/master/docs/setup/swarm/migration/2.0-to-2.1.md",tags:[],version:"current",sidebarPosition:7,frontMatter:{id:"2.0-to-2.1",title:"V2.0 to V2.1",slug:"/setup/swarm/migration/2.0-to-2.1",sidebar_position:7},sidebar:"install",previous:{title:"V1.15 to V2.0",permalink:"/docs/next/setup/swarm/migration/1.15-to-2.0"},next:{title:"V2.2 to V2.3",permalink:"/docs/next/setup/swarm/migration/2.2-to-2.3"}},d={},c=[{value:"Database modifications",id:"database-modifications",level:2},{value:"Email addresses",id:"email-addresses",level:3},{value:"Dissemination info",id:"dissemination-info",level:3}];function l(e){const n={a:"a",admonition:"admonition",br:"br",code:"code",em:"em",h1:"h1",h2:"h2",h3:"h3",p:"p",pre:"pre",strong:"strong",...(0,s.R)(),...e.components};return(0,i.jsxs)(i.Fragment,{children:[(0,i.jsx)(n.p,{children:"Steps to migrate REGARDS from version 2.0 to 2.1"}),"\n",(0,i.jsx)(n.h2,{id:"database-modifications",children:"Database modifications"}),"\n",(0,i.jsx)(n.h3,{id:"email-addresses",children:"Email addresses"}),"\n",(0,i.jsx)(n.p,{children:"In version 2.1 of REGARDS, it is no longer allowed to have multiple users with identical email addresses, except\nwhen they differ by case.\nIt is therefore necessary before the migration to check the uniqueness of the usernames by case-sensitive email address."}),"\n",(0,i.jsxs)(n.p,{children:["Here are some SQL queries to run on the admin schema of\nthe ",(0,i.jsx)(n.a,{href:"/docs/next/development/concepts/multitenant/",children:"rs-instance"})," database for the instance microservice, which\ndisplay the duplicate user accounts that will need to be removed for the migration to REGARDS 2.1."]}),"\n",(0,i.jsx)(n.admonition,{type:"note",children:(0,i.jsxs)(n.p,{children:["For the name ",(0,i.jsx)(n.code,{children:"rs-instance"})," database, you may use another name, but we advise this name."]})}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-sql",children:'SELECT LOWER(t_account.email), count(*)\nFROM "admin"."t_account"\ngroup by LOWER(t_account.email)\nHAVING COUNT(*) > 1;\n\nSELECT *\nFROM "admin"."t_account"\nWHERE LOWER(email) IN\n      (SELECT LOWER(t_account.email) FROM "admin"."t_account" group by LOWER(t_account.email) HAVING COUNT(*) > 1)\nORDER BY email;\n'})}),"\n",(0,i.jsx)(n.p,{children:"In order for the REGARDS application to be migrated and started, the previous queries must return no results."}),"\n",(0,i.jsxs)(n.admonition,{type:"info",children:[(0,i.jsx)(n.p,{children:"If several results are returned, you must decide which REGARDS accounts to delete."}),(0,i.jsxs)(n.p,{children:["You must be connected to the ",(0,i.jsx)(n.strong,{children:"admin schema"})," of the ",(0,i.jsx)(n.code,{children:"rs-instance"})," database.",(0,i.jsx)(n.br,{}),"\n","Execute an SQL query to delete the invalid accounts from the ",(0,i.jsx)(n.code,{children:"t_account"})," table, you need to keep track of the removed\naccounts for a later step."]}),(0,i.jsxs)(n.p,{children:["For the remaining valid accounts, you can update their associated projects by running an SQL query that inserts the\naccount identifier and the project identifier (from the ",(0,i.jsx)(n.code,{children:"t_project"})," table) into the ",(0,i.jsx)(n.code,{children:"ta_account_project"})," table. This\ntable defines the link between a project and an account in REGARDS."]}),(0,i.jsxs)(n.p,{children:["Then, delete all project users linked to the removed accounts from each project schema.",(0,i.jsx)(n.br,{}),"\n","This can be done by executing SQL queries on the ",(0,i.jsx)(n.code,{children:"t_project_user"})," table within each project schema under the admin\nschema."]}),(0,i.jsx)(n.p,{children:(0,i.jsx)(n.a,{href:"/docs/next/development/services/admin-instance/conception/",children:"See info in rs-admin-instance microservice : access right"})})]}),"\n",(0,i.jsx)(n.h3,{id:"dissemination-info",children:"Dissemination info"}),"\n",(0,i.jsxs)(n.p,{children:["In the version 2.1 of REGARDS, the database no long allows duplicated disseminations (same recipient and same\nrequestId) for features (FEM products).\nIt means that all existing duplicated dissemination must be removed.\nHere are some SQL queries to run on the fem schema of the project database to create a new table with the duplicated\ndisseminations.\nPlease note that you need to ",(0,i.jsx)(n.em,{children:"update the following script with realistic dates"}),", depending on your\nfem.t_feature_dissemination size.\nKeep the time interval short, and repeat scripts to cover all features stored in database."]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-sql",children:"DROP TABLE IF EXISTS fem.TMP_DOUBLE_DISS_DETECTED;\nCREATE TABLE fem.TMP_DOUBLE_DISS_DETECTED AS\nSELECT id, B.feature_id, B.label, request_date, ack_date, doublon_count\nFROM fem.t_feature_dissemination_info B\n         JOIN (SELECT label, feature_id, COUNT(*) AS doublon_count\n               FROM fem.t_feature_dissemination_info\n               WHERE request_date BETWEEN '2010-03-01 00:00:00' AND '2030-04-01 00:00:00'\n                 AND feature_id > 0\n               GROUP BY label, feature_id\n               HAVING COUNT(*) > 1) AS sous_requet\n              ON sous_requet.feature_id = B.feature_id AND sous_requet.label = B.label;\n\nDROP TABLE IF EXISTS fem.TMP_OLDEST_DISS_ACK;\nCREATE TABLE fem.TMP_OLDEST_DISS_ACK AS\nSELECT DISTINCT ON\n(\n    label,\n    feature_id\n) *\n    FROM fem.TMP_DOUBLE_DISS_DETECTED\n    WHERE ack_date is not null\n    ORDER BY label, feature_id, ack_date ASC;\n\nDROP TABLE IF EXISTS fem.TMP_OLDEST_DISS_WITHOUT_ACK;\nCREATE TABLE fem.TMP_OLDEST_DISS_WITHOUT_ACK AS\nSELECT DISTINCT ON\n(\n    label,\n    feature_id\n) *\n    FROM fem.tmp_double_diss_detected\n    WHERE ack_date is null\n    ORDER BY label, feature_id, request_date ASC;\n\nDELETE\nFROM fem.tmp_oldest_diss_without_ack t\nWHERE EXISTS (SELECT 1\n              FROM fem.TMP_OLDEST_DISS_ACK a\n              WHERE a.feature_id = t.feature_id\n                AND a.label = t.label);\n\nSELECT count(*)\nFROM fem.TMP_DOUBLE_DISS_DETECTED;\n"})}),"\n",(0,i.jsx)(n.p,{children:"This script shows how many duplicated entries have been detected."}),"\n",(0,i.jsx)(n.p,{children:"Check now the table fem.TMP_DOUBLE_DISS_DETECTED. If there is at least one entry, you have to launch the following\nsecond script.\nThis second script delete all duplicated disseminations, and update the dissemination_pending value to false."}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-sql",children:"DELETE\nFROM fem.t_feature_dissemination_info\nWHERE id IN (SELECT id FROM fem.TMP_OLDEST_DISS_ACK);\nDELETE\nFROM fem.t_feature_dissemination_info\nWHERE id IN (SELECT id FROM fem.TMP_OLDEST_DISS_WITHOUT_ACK);\nUPDATE fem.t_feature\nSET dissemination_pending = FALSE\nWHERE id IN (SELECT feature_id FROM fem.TMP_OLDEST_DISS_ACK);\nUPDATE fem.t_feature\nSET dissemination_pending = FALSE\nWHERE id IN (SELECT feature_id FROM fem.TMP_OLDEST_DISS_WITHOUT_ACK);\n"})}),"\n",(0,i.jsx)(n.p,{children:"This script does not return anything."}),"\n",(0,i.jsx)(n.p,{children:"Once all FEM features have been treated, you can launch the third script:"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-sql",children:"DROP TABLE fem.TMP_DOUBLE_DISS_DETECTED;\nDROP TABLE fem.TMP_OLDEST_DISS_ACK;\nDROP TABLE fem.TMP_OLDEST_DISS_WITHOUT_ACK;\n"})}),"\n",(0,i.jsx)(n.p,{children:"This script does not return anything."}),"\n",(0,i.jsx)(n.h1,{id:"new-downloader-service",children:"New downloader service"}),"\n",(0,i.jsx)(n.p,{children:"As of REGARDS version 2.1.0, file download functionality has been delegated to a dedicated microservice.\nIt's no longer the storage microservice that's in charge, but the new downloader microservice."}),"\n",(0,i.jsxs)(n.p,{children:["To add the downloader microservice to your REGARDS deployment as of version 2.1.0, add it to your inventory as indicated\nin the ",(0,i.jsx)(n.a,{href:"/docs/next/setup/swarm/advanced/microservice-setup#file-download-management",children:"installation manual"}),"."]}),"\n",(0,i.jsx)(n.p,{children:"The aim of this new microservice is to make downloading highly scalable."})]})}function u(e={}){const{wrapper:n}={...(0,s.R)(),...e.components};return n?(0,i.jsx)(n,{...e,children:(0,i.jsx)(l,{...e})}):l(e)}},28453:(e,n,t)=>{t.d(n,{R:()=>o,x:()=>r});var i=t(96540);const s={},a=i.createContext(s);function o(e){const n=i.useContext(a);return i.useMemo((function(){return"function"==typeof e?e(n):{...n,...e}}),[n,e])}function r(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(s):e.components||s:o(e.components),i.createElement(a.Provider,{value:n},e.children)}}}]);