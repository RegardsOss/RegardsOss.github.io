(window.webpackJsonp=window.webpackJsonp||[]).push([[640],{2699:function(e,t,n){"use strict";n.d(t,"a",(function(){return p})),n.d(t,"b",(function(){return h}));var i=n(0),a=n.n(i);function r(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function o(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(e);t&&(i=i.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,i)}return n}function s(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?o(Object(n),!0).forEach((function(t){r(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):o(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}function c(e,t){if(null==e)return{};var n,i,a=function(e,t){if(null==e)return{};var n,i,a={},r=Object.keys(e);for(i=0;i<r.length;i++)n=r[i],t.indexOf(n)>=0||(a[n]=e[n]);return a}(e,t);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);for(i=0;i<r.length;i++)n=r[i],t.indexOf(n)>=0||Object.prototype.propertyIsEnumerable.call(e,n)&&(a[n]=e[n])}return a}var l=a.a.createContext({}),b=function(e){var t=a.a.useContext(l),n=t;return e&&(n="function"==typeof e?e(t):s(s({},t),e)),n},p=function(e){var t=b(e.components);return a.a.createElement(l.Provider,{value:t},e.children)},d={inlineCode:"code",wrapper:function(e){var t=e.children;return a.a.createElement(a.a.Fragment,{},t)}},u=a.a.forwardRef((function(e,t){var n=e.components,i=e.mdxType,r=e.originalType,o=e.parentName,l=c(e,["components","mdxType","originalType","parentName"]),p=b(n),u=i,h=p["".concat(o,".").concat(u)]||p[u]||d[u]||r;return n?a.a.createElement(h,s(s({ref:t},l),{},{components:n})):a.a.createElement(h,s({ref:t},l))}));function h(e,t){var n=arguments,i=t&&t.mdxType;if("string"==typeof e||i){var r=n.length,o=new Array(r);o[0]=u;var s={};for(var c in t)hasOwnProperty.call(t,c)&&(s[c]=t[c]);s.originalType=e,s.mdxType="string"==typeof e?e:i,o[1]=s;for(var l=2;l<r;l++)o[l]=n[l];return a.a.createElement.apply(null,o)}return a.a.createElement.apply(null,n)}u.displayName="MDXCreateElement"},2726:function(e,t,n){"use strict";n.r(t),t.default=n.p+"assets/images/domain_entities-15d72851b1398dbf64bbc6abea400082.png"},2727:function(e,t,n){"use strict";n.r(t),t.default=n.p+"assets/images/general_algo-8d5685189a211455dc7fd9ab88b79462.png"},2728:function(e,t,n){"use strict";n.r(t),t.default=n.p+"assets/images/order_algo-9a097b89d03fb1a76195a4349796a307.png"},712:function(e,t,n){"use strict";n.r(t),n.d(t,"frontMatter",(function(){return o})),n.d(t,"metadata",(function(){return s})),n.d(t,"toc",(function(){return c})),n.d(t,"default",(function(){return b}));var i=n(3),a=n(7),r=(n(0),n(2699)),o={id:"backend-processing-overview",title:"REGARDS processing microservice",sidebar_label:"Overview",slug:"/development/backend/processing/overview"},s={unversionedId:"development/backend/regards/processing/backend-processing-overview",id:"development/backend/regards/processing/backend-processing-overview",isDocsHomePage:!1,title:"REGARDS processing microservice",description:"Overview",source:"@site/docs/development/backend/regards/processing/processing.md",slug:"/development/backend/processing/overview",permalink:"/fr/docs/development/backend/processing/overview",editUrl:"https://github.com/RegardsOss/RegardsOss.github.io/edit/master/docs/development/backend/regards/processing/processing.md",version:"current",sidebar_label:"Overview",sidebar:"dev",previous:{title:"REGARDS Order API",permalink:"/fr/docs/development/backend/order/api"},next:{title:"REGARDS Processing Process API",permalink:"/fr/docs/development/backend/processing/api/process"}},c=[{value:"Overview",id:"overview",children:[]},{value:"Processing architecture",id:"processing-architecture",children:[{value:"Domain entities",id:"domain-entities",children:[]},{value:"<code>PBatch</code>",id:"pbatch",children:[]},{value:"<code>PExecution</code>",id:"pexecution",children:[]},{value:"<code>PInputFile</code>",id:"pinputfile",children:[]},{value:"<code>PStep</code>",id:"pstep",children:[]},{value:"<code>POutputFile</code>",id:"poutputfile",children:[]}]},{value:"General algorithm",id:"general-algorithm",children:[]},{value:"Technical details",id:"technical-details",children:[{value:"Workload engine / executable / execution context",id:"workload-engine--executable--execution-context",children:[]},{value:"Reactive-first service",id:"reactive-first-service",children:[]},{value:"Clean architecture",id:"clean-architecture",children:[]},{value:"<code>Order</code> specific design choices",id:"order-specific-design-choices",children:[]}]},{value:"Configuration",id:"configuration",children:[]},{value:"Available APIs",id:"available-apis",children:[]}],l={toc:c};function b(e){var t=e.components,o=Object(a.a)(e,["components"]);return Object(r.b)("wrapper",Object(i.a)({},l,o,{components:t,mdxType:"MDXLayout"}),Object(r.b)("h2",{id:"overview"},"Overview"),Object(r.b)("p",null,"The main reason for ",Object(r.b)("inlineCode",{parentName:"p"},"Processing")," is to apply treatments to ordered data files,\nbefore they are served to the end user. However, this microservice has been\ndesigned to be able to do more."),Object(r.b)("h2",{id:"processing-architecture"},"Processing architecture"),Object(r.b)("h3",{id:"domain-entities"},"Domain entities"),Object(r.b)("p",null,"There are five main entities introduced by ",Object(r.b)("inlineCode",{parentName:"p"},"Processing"),". Since their names are\nrather generic and semantically overloaded, they are prefixed by a ",Object(r.b)("inlineCode",{parentName:"p"},"P"),' referring\nto the "',Object(r.b)("inlineCode",{parentName:"p"},"P"),'"rocessing context.'),Object(r.b)("p",null," ",Object(r.b)("img",{alt:"Domain entities",src:n(2726).default})),Object(r.b)("p",null,"Before describing each of the entities in more details, here is the very crude\nidea behind this architecture:"),Object(r.b)("ul",null,Object(r.b)("li",{parentName:"ul"},"a ",Object(r.b)("inlineCode",{parentName:"li"},"PProcess")," describes a program to be run on data, the program can be configured\nwith parameters,"),Object(r.b)("li",{parentName:"ul"},"a ",Object(r.b)("inlineCode",{parentName:"li"},"PBatch")," describes a logical group of executions of a ",Object(r.b)("inlineCode",{parentName:"li"},"PProcess"),", providing\nvalues for the program configuration parameters,"),Object(r.b)("li",{parentName:"ul"},"a ",Object(r.b)("inlineCode",{parentName:"li"},"PExecution")," describes the launch of the program on data, providing the actual\ninput files,"),Object(r.b)("li",{parentName:"ul"},"a ",Object(r.b)("inlineCode",{parentName:"li"},"PInputFile")," the description of a file to be used during an execution (it is\nactually a glorified URL pointing to some data),  "),Object(r.b)("li",{parentName:"ul"},"a ",Object(r.b)("inlineCode",{parentName:"li"},"PStep")," is en event occuring during an execution (flagging the execution as\nrunning, in success or in failure),"),Object(r.b)("li",{parentName:"ul"},"a ",Object(r.b)("inlineCode",{parentName:"li"},"POutputFile")," is a result of an execution, and may refer to the ",Object(r.b)("inlineCode",{parentName:"li"},"PInputFile"),"s\nwhich were used to build it.")),Object(r.b)("h4",{id:"pprocess"},Object(r.b)("inlineCode",{parentName:"h4"},"PProcess")),Object(r.b)("p",null,"At the top of the abstraction hierarchy is the ",Object(r.b)("inlineCode",{parentName:"p"},"PProcess"),". A ",Object(r.b)("inlineCode",{parentName:"p"},"PProcess")," is the\nabstract description of a procedure to be applied to one or many files."),Object(r.b)("p",null,"The ",Object(r.b)("inlineCode",{parentName:"p"},"PProcess")," has several expected attribute:"),Object(r.b)("ul",null,Object(r.b)("li",{parentName:"ul"},"an UUID,"),Object(r.b)("li",{parentName:"ul"},"a name,"),Object(r.b)("li",{parentName:"ul"},'a set of metadata named the "process info".')),Object(r.b)("p",null,"It also provides more specific attributes:"),Object(r.b)("ul",null,Object(r.b)("li",{parentName:"ul"},"a size forecast, allowing to predict before launching execution, the expected\nquantity of data outputted for a given input size,"),Object(r.b)("li",{parentName:"ul"},"a duration forecast, allowing to predict the expected duration of treatment,\nallowing to compute a timeout duration for each execution,"),Object(r.b)("li",{parentName:"ul"},"a mapper from output to input, telling how to assign the corresponding inputs\nto a given output,"),Object(r.b)("li",{parentName:"ul"},"validators for ",Object(r.b)("inlineCode",{parentName:"li"},"PBatch")," and ",Object(r.b)("inlineCode",{parentName:"li"},"PExecution")," creation using this ",Object(r.b)("inlineCode",{parentName:"li"},"PProcess"),",\nallowing to decide in advance if the process may be used in a given context,"),Object(r.b)("li",{parentName:"ul"},"a workload engine and an executable, describing what and how to run the\ncorresponding program ; these mechanism will be explained below.")),Object(r.b)("p",null,Object(r.b)("inlineCode",{parentName:"p"},"PProcess")," is an interface, and there is a default basic concrete class\n",Object(r.b)("inlineCode",{parentName:"p"},"ConcretePProcess")," implementing it as a simple POJO. However, any type of class\ncould implement ",Object(r.b)("inlineCode",{parentName:"p"},"PProcess"),", depending on the final application."),Object(r.b)("h3",{id:"pbatch"},Object(r.b)("inlineCode",{parentName:"h3"},"PBatch")),Object(r.b)("p",null,"A user has data to process, and has chosen a ",Object(r.b)("inlineCode",{parentName:"p"},"PProcess")," to treat them.\nIn order to launch treatments (also called executions), the user must\nfirst acquire a ",Object(r.b)("inlineCode",{parentName:"p"},"PBatch"),", by calling the ",Object(r.b)("inlineCode",{parentName:"p"},"Processing")," service and providing:"),Object(r.b)("ul",null,Object(r.b)("li",{parentName:"ul"},"the ",Object(r.b)("inlineCode",{parentName:"li"},"PProcess")," configuration parameter values to be used by all executions"),Object(r.b)("li",{parentName:"ul"},"statistics regarding the quantity of data to treat.")),Object(r.b)("p",null,"This allows the ",Object(r.b)("inlineCode",{parentName:"p"},"Processing")," service to decide whether the treatments\ncan be done or not. For instance, some configuration parameter values might\nbe wrong, or some quota of use may be reached. This validation is done\nusing the ",Object(r.b)("inlineCode",{parentName:"p"},"PProcess")," batch validator."),Object(r.b)("p",null,"If the batch validator accepts the information, it delivers a ",Object(r.b)("inlineCode",{parentName:"p"},"PBatch"),"\ninstance, saved in the ",Object(r.b)("inlineCode",{parentName:"p"},"Processing")," service database. This batch has:"),Object(r.b)("ul",null,Object(r.b)("li",{parentName:"ul"},"an ID,"),Object(r.b)("li",{parentName:"ul"},"a correlation ID given by the user when requesting the creation of the batch,\nwhich will be provided for any execution result later,"),Object(r.b)("li",{parentName:"ul"},"the values for the ",Object(r.b)("inlineCode",{parentName:"li"},"PProcess")," parameters which will be used by all the\nexecutions launched in the context of this batch.")),Object(r.b)("p",null,"A batch is an immutable entity: it never changes once it has been created."),Object(r.b)("h4",{id:"abusing-batches-is-possible"},"Abusing batches is possible"),Object(r.b)("p",null,"Once the batch has been created and delivered to the user, the user may use\nit and abuse it. Theere is for now no limitation of the number of executions\na user can do using the same batch ID. This limitation is not enforced because\nsometimes, the input statistics provided at the batch creation may be\nslightly inexact, and it is hard to predict in advance how many executions\nwill be needed to treat all the data. Instead of making bad heuristics,\nthe choice has been made to trust the user to not abuse the system, especially\nsince for now the only user for ",Object(r.b)("inlineCode",{parentName:"p"},"Processing")," is the ",Object(r.b)("inlineCode",{parentName:"p"},"Order")," service, which\nhas no interest in abusing batches."),Object(r.b)("p",null,"However, if ",Object(r.b)("inlineCode",{parentName:"p"},"Processing")," had to be accessed directly by end users in the future,\nit will require to enforce a more strict policy regarding the execution creation\nwithin a given batch."),Object(r.b)("h3",{id:"pexecution"},Object(r.b)("inlineCode",{parentName:"h3"},"PExecution")),Object(r.b)("p",null,"When the user has received the batch response providing the batch ID, the\nuser can send execution request to ",Object(r.b)("inlineCode",{parentName:"p"},"Processing"),", using an AMQP\n",Object(r.b)("inlineCode",{parentName:"p"},"PExecutionRequestEvent")," message."),Object(r.b)("p",null,"The execution request contains:"),Object(r.b)("ul",null,Object(r.b)("li",{parentName:"ul"},"the batch ID it corresponds to (determining the configuration parameters\nfor the ",Object(r.b)("inlineCode",{parentName:"li"},"PProcess"),"),"),Object(r.b)("li",{parentName:"ul"},"the list of ",Object(r.b)("inlineCode",{parentName:"li"},"PInputFile")," to use as input data for this execution,"),Object(r.b)("li",{parentName:"ul"},"an execution correlation ID, which will be provided back when ",Object(r.b)("inlineCode",{parentName:"li"},"Processing"),"\nreturns the execution result (as an AMQP ",Object(r.b)("inlineCode",{parentName:"li"},"PExecutionResultEvent"),").")),Object(r.b)("p",null,"When the ",Object(r.b)("inlineCode",{parentName:"p"},"Processing")," service receives the request, it validates it using the\n",Object(r.b)("inlineCode",{parentName:"p"},"PProcess")," execution validator, and if accepted, saves it in the service\ndatabase and then runs it, using the ",Object(r.b)("inlineCode",{parentName:"p"},"PProcess")," executable and workload engine."),Object(r.b)("p",null,"A ",Object(r.b)("inlineCode",{parentName:"p"},"Pexecution")," is a mutable entity: while running the executable, ",Object(r.b)("inlineCode",{parentName:"p"},"PStep"),"s are\nemmitted and added to the ",Object(r.b)("inlineCode",{parentName:"p"},"PExecution"),", providing a current status and last update\ntimestamp for the execution."),Object(r.b)("h3",{id:"pinputfile"},Object(r.b)("inlineCode",{parentName:"h3"},"PInputFile")),Object(r.b)("p",null,"A ",Object(r.b)("inlineCode",{parentName:"p"},"PInputFile")," is an input file descriptor, defining:"),Object(r.b)("ul",null,Object(r.b)("li",{parentName:"ul"},"where the file is located using an URL,"),Object(r.b)("li",{parentName:"ul"},"the file size/content type/checksum,"),Object(r.b)("li",{parentName:"ul"},"a file-specific correlation ID, which will be used when reporting back\nthe execution result, allowing to map output files back to the input file\ncorrelation IDs which were used to generate the output file.")),Object(r.b)("p",null,"A ",Object(r.b)("inlineCode",{parentName:"p"},"PInputFile")," is an immutable entity."),Object(r.b)("h3",{id:"pstep"},Object(r.b)("inlineCode",{parentName:"h3"},"PStep")),Object(r.b)("p",null,"While running in the context of an execution, the process-supplied ",Object(r.b)("inlineCode",{parentName:"p"},"IExecutable"),"\nhas access to en event notifier, allowing to inform the ",Object(r.b)("inlineCode",{parentName:"p"},"Processing")," service\nthat steps have occurred in the execution."),Object(r.b)("p",null,"A ",Object(r.b)("inlineCode",{parentName:"p"},"PStep")," is an immutable entity with the following fields:"),Object(r.b)("ul",null,Object(r.b)("li",{parentName:"ul"},"a status defining the type of step (RUNNING, SUCCESS, FAILURE, etc.)."),Object(r.b)("li",{parentName:"ul"},"an optional set of output files used if the step is final.")),Object(r.b)("p",null,"An execution status can be transitory of final. Final statuses are:"),Object(r.b)("ul",null,Object(r.b)("li",{parentName:"ul"},"SUCCESS, "),Object(r.b)("li",{parentName:"ul"},"FAILURE, "),Object(r.b)("li",{parentName:"ul"},"and TIMED_OUT. ")),Object(r.b)("p",null,"Once a final status is reached, the execution is considered finished and\nthe ",Object(r.b)("inlineCode",{parentName:"p"},"PExecutionResultEvent")," is created and sent to the AMQP broker."),Object(r.b)("h3",{id:"poutputfile"},Object(r.b)("inlineCode",{parentName:"h3"},"POutputFile")),Object(r.b)("p",null,"When a ",Object(r.b)("inlineCode",{parentName:"p"},"PStep")," is final, it is supposed to contain a list of output results,\nin the form of ",Object(r.b)("inlineCode",{parentName:"p"},"POutputFile"),"s."),Object(r.b)("p",null,"A ",Object(r.b)("inlineCode",{parentName:"p"},"POutputFile")," is, like the ",Object(r.b)("inlineCode",{parentName:"p"},"PInputFile"),", a wrapper around an URL. It has:"),Object(r.b)("ul",null,Object(r.b)("li",{parentName:"ul"},"an ID,"),Object(r.b)("li",{parentName:"ul"},"a reference to the corresponding execution UUID,"),Object(r.b)("li",{parentName:"ul"},"a file name, URL, size and checksum,"),Object(r.b)("li",{parentName:"ul"},"a list of optional ",Object(r.b)("inlineCode",{parentName:"li"},"PInputFile")," correlation IDs, allowing to make reference\nto the input which generated this output.")),Object(r.b)("p",null,"The ",Object(r.b)("inlineCode",{parentName:"p"},"POutputFile")," is mutable and also has a few technical flags:"),Object(r.b)("ul",null,Object(r.b)("li",{parentName:"ul"},Object(r.b)("inlineCode",{parentName:"li"},"downloaded")," tells if the file has been downloaded by the client,"),Object(r.b)("li",{parentName:"ul"},Object(r.b)("inlineCode",{parentName:"li"},"deleted")," tells if the file has been deleted and is not present for download anymore.")),Object(r.b)("h2",{id:"general-algorithm"},"General algorithm"),Object(r.b)("p",null,"Here is a description of the way a client needs to interact with ",Object(r.b)("inlineCode",{parentName:"p"},"Processing")," in order\nto launch executions. (Only the 'happy path' is represented.)"),Object(r.b)("p",null,Object(r.b)("img",{alt:"General &#39;Happy Path&#39; Algorithm",src:n(2727).default})),Object(r.b)("p",null,"The client needs to interact first with the REST API in order to get the ",Object(r.b)("inlineCode",{parentName:"p"},"PProcess"),"\ndetails and then create a ",Object(r.b)("inlineCode",{parentName:"p"},"PBatch"),"."),Object(r.b)("p",null,"Then, the user needs to send ",Object(r.b)("inlineCode",{parentName:"p"},"PExecution")," requests events through AMQP."),Object(r.b)("p",null,"The ",Object(r.b)("inlineCode",{parentName:"p"},"Processing")," service then launches the work using the workload engine for\nthe corresponding process, which launches an executable (provided by the process)."),Object(r.b)("p",null,"Running the executable generates steps, which are notified using a step notifier present\nin the execution context which is given to the executable."),Object(r.b)("p",null,"When the notifier receives a final step (step with a final ",Object(r.b)("inlineCode",{parentName:"p"},"ExecutionStatus"),"), it\ngenerates an execution result event sent back to the client though AMQP."),Object(r.b)("p",null,"The final step contains references to the output files generated during the\nexecution. The user is free to download them by whichever means it has. Once\nthe download is done, the user notifies ",Object(r.b)("inlineCode",{parentName:"p"},"Processing")," through AMQP of the\ndownloaded files. ",Object(r.b)("inlineCode",{parentName:"p"},"Processing")," marks them as downloaded."),Object(r.b)("p",null,"A scheduled service runs at a given periodicity to take all the output files\nmarked as downloaded, and delete them from the shared storage space where they\nhave been stored, and marks the output files as deleted in the database."),Object(r.b)("p",null,"A scheduled service runs at a given periodicity to take all the batches for\nwhich all the executions have been finished for a given duration, and deletes them\nfrom the database. This deletion cascades to all the executions, steps, and output\nfiles linked to this batch."),Object(r.b)("h2",{id:"technical-details"},"Technical details"),Object(r.b)("h3",{id:"workload-engine--executable--execution-context"},"Workload engine / executable / execution context"),Object(r.b)("p",null,"This section describes the why and how of the workload engine,\nand the mechanism by which executables notify execution events."),Object(r.b)("p",null,"The ",Object(r.b)("inlineCode",{parentName:"p"},"Processing")," service is an empty shell. It does not run the processes\nitself, but delegates the running to the workload engine referenced by a ",Object(r.b)("inlineCode",{parentName:"p"},"PProcess"),"."),Object(r.b)("h4",{id:"generalities-on-workload-engines"},"Generalities on workload engines"),Object(r.b)("p",null,"The ",Object(r.b)("inlineCode",{parentName:"p"},"WorkloadEngine")," responsibility is then to define how the ",Object(r.b)("inlineCode",{parentName:"p"},"IExecutable"),"\ndefined by the process will be launched (which could be synchronously,\nin a separate thread, in a different virtual machine, etc.).\nA ",Object(r.b)("inlineCode",{parentName:"p"},"WorkloadEngine")," is a way to abstract the running of processes. It is an\ninterface to frameworks like REGARDS jobs, Spring Batch, etc. whose purpose\nis to launch programs on demand."),Object(r.b)("p",null,"A ",Object(r.b)("inlineCode",{parentName:"p"},"WorkloadEngine")," instance has a name, and references itself when loaded\nat bootstrap in a ",Object(r.b)("inlineCode",{parentName:"p"},"WorkloadEngineRepository"),". A ",Object(r.b)("inlineCode",{parentName:"p"},"PProcess")," will provide\nthe name of the engine it is supposed to run on."),Object(r.b)("p",null,"When an execution of the ",Object(r.b)("inlineCode",{parentName:"p"},"PProcess")," is started, the service will load the\ncorresponding ",Object(r.b)("inlineCode",{parentName:"p"},"WorkloadEngine"),". For instance, in the case of the deployment\nof ",Object(r.b)("inlineCode",{parentName:"p"},"Processsing")," for launching treatments on orders, the ",Object(r.b)("inlineCode",{parentName:"p"},"WorkloadEngine")," used\nby all processes is for now based on REGARDS jobs. Launching an execution\nwith this engine is just creating a ",Object(r.b)("inlineCode",{parentName:"p"},"LaunchingExecutionJob")," as ",Object(r.b)("inlineCode",{parentName:"p"},"QUEUED"),"."),Object(r.b)("h4",{id:"executionevent"},Object(r.b)("inlineCode",{parentName:"h4"},"ExecutionEvent")),Object(r.b)("p",null,"An execution event signifies that something happened during an execution.\nThe execution event contains an optional ",Object(r.b)("inlineCode",{parentName:"p"},"PStep")," (which may be final or not)\nand an optional list of ",Object(r.b)("inlineCode",{parentName:"p"},"POutputFiles"),". The event can signify that a step\nhas been reached, or that output files have been generated, or both."),Object(r.b)("p",null,"(In the context of the use of ",Object(r.b)("inlineCode",{parentName:"p"},"Processing")," for order data treatment, the\nprocesses must send output files only along with a final step, but this\nis a limitation given by the context of use, rather than a limitation of\nthe domain as it is designed.)"),Object(r.b)("h4",{id:"iexecutioneventnotifier"},Object(r.b)("inlineCode",{parentName:"h4"},"IExecutionEventNotifier")),Object(r.b)("p",null,"The ",Object(r.b)("inlineCode",{parentName:"p"},"IExecutionEventNotifier")," interface defines how to deal with events\nsent during an execution. It is a simple functional interface which takes\nas input an ",Object(r.b)("inlineCode",{parentName:"p"},"ExecutionEvent")," and returns a ",Object(r.b)("inlineCode",{parentName:"p"},"Mono<PExecution>"),"\n(with the steps potentially updated with the event step). (The ",Object(r.b)("inlineCode",{parentName:"p"},"Mono")," wrapper\nsignifies that a side-effect has been done during the execution, for instance\na modification of the execution in the database.)"),Object(r.b)("h4",{id:"executioncontext"},Object(r.b)("inlineCode",{parentName:"h4"},"ExecutionContext")),Object(r.b)("p",null,"An ",Object(r.b)("inlineCode",{parentName:"p"},"ExecutionContext")," provides access to:"),Object(r.b)("ul",null,Object(r.b)("li",{parentName:"ul"},"the ",Object(r.b)("inlineCode",{parentName:"li"},"PProcess")," and ",Object(r.b)("inlineCode",{parentName:"li"},"PBatch")," corresponding to the execution,"),Object(r.b)("li",{parentName:"ul"},"an ",Object(r.b)("inlineCode",{parentName:"li"},"IExecutionEventNotifier"),","),Object(r.b)("li",{parentName:"ul"},"a mutable map of metadata.")),Object(r.b)("h4",{id:"iexecutable"},Object(r.b)("inlineCode",{parentName:"h4"},"IExecutable")),Object(r.b)("p",null,"An ",Object(r.b)("inlineCode",{parentName:"p"},"IExecutable")," is a function which takes as input an ",Object(r.b)("inlineCode",{parentName:"p"},"ExecutionContext")," and\nreturns a ",Object(r.b)("inlineCode",{parentName:"p"},"Mono<ExecutionContext>"),". The ",Object(r.b)("inlineCode",{parentName:"p"},"Mono")," wrapper signifies that\nside effects may occur. "),Object(r.b)("p",null,Object(r.b)("inlineCode",{parentName:"p"},"IExecutable"),"s are simple functions which can be chained, allowing for\ncompositionality and modularity. Simple executable steps can be aggregated\ninto more complex executables."),Object(r.b)("p",null,"These functions are meant to do side effects, and use the input ",Object(r.b)("inlineCode",{parentName:"p"},"ExecutionContext"),"'s\nevent notifier, in order to advance steps or signify that outputs have been\ngenerated. "),Object(r.b)("p",null,"An ",Object(r.b)("inlineCode",{parentName:"p"},"IExecutable")," is not supposed to know anything about the workload engine\nthat runs it, but it practise some information can be passed by the workload\nengine to the executable through the ",Object(r.b)("inlineCode",{parentName:"p"},"ExecutionContext")," metadata."),Object(r.b)("h3",{id:"reactive-first-service"},"Reactive-first service"),Object(r.b)("p",null,"The ",Object(r.b)("inlineCode",{parentName:"p"},"Processing")," microservice has been identified as a potential bottleneck\nwith heavy load. Because it might also be often prompted for monitoring\ninformation, the choice has been made to make this microservice with a\nreactive stack, using Spring Webflux and Netty as the backbone."),Object(r.b)("p",null,"However, in the context of REGARDS, and because there is a lot of\nsecurity configuration inherited from REGARDS, the service can be\n(and has been) configured to run in a servlet context, backed by Jetty."),Object(r.b)("p",null,"It should be beneficial to the service to remain in a reactive-first\nlogic, especially in its domain core. The reactive model permeates throughout\nthe code in the form of function from values to ",Object(r.b)("inlineCode",{parentName:"p"},"Mono"),"s and ",Object(r.b)("inlineCode",{parentName:"p"},"Flux"),"es of\nvalues. (Clean code often tends to leave such frameworks out of the\ndomain, but it is very hard to do so with Reactor ; especially since\nthe underlying interfaces do not discriminate between single-valued publishers\nand multi-valued ones, and typing everything as ",Object(r.b)("inlineCode",{parentName:"p"},"Publisher")," is not helpful.)"),Object(r.b)("p",null,"As for the REST controllers, two versions are provided: a reactive and\na servlet one."),Object(r.b)("h3",{id:"clean-architecture"},"Clean architecture"),Object(r.b)("p",null,"The ",Object(r.b)("inlineCode",{parentName:"p"},"Processing")," service is based on 'Clean Architecture' principles.\nThis means that it has a domain core and several adapters, which abstract away\nthe different ways to interact with the external world."),Object(r.b)("p",null,"The core defines:"),Object(r.b)("ul",null,Object(r.b)("li",{parentName:"ul"},"the base entities describes above,"),Object(r.b)("li",{parentName:"ul"},"the interfaces for services and repositories to manage the entities.")),Object(r.b)("p",null,"The main adapters are:"),Object(r.b)("ul",null,Object(r.b)("li",{parentName:"ul"},"database access,"),Object(r.b)("li",{parentName:"ul"},"event handlers,"),Object(r.b)("li",{parentName:"ul"},"process management,"),Object(r.b)("li",{parentName:"ul"},"workload engine.")),Object(r.b)("h4",{id:"database-access-adapter"},"Database access adapter"),Object(r.b)("p",null,"This adapter uses a reactive dirver (r2dbc) and is not destined to be reimplemented\nfor another context, unless there is a need to connect to something else than\npostgresql."),Object(r.b)("p",null,"In order to allow ",Object(r.b)("inlineCode",{parentName:"p"},"Processing")," to be run effectively in all contexts, and\nin order to allow imitations on ",Object(r.b)("inlineCode",{parentName:"p"},"PProcess"),", the choice has been made to\nuse the reactive driver R2DBC to the database."),Object(r.b)("p",null,"This allows to use ",Object(r.b)("inlineCode",{parentName:"p"},"Processing")," in a reactive context without suffering\nfrom thread-blocking in database calls."),Object(r.b)("p",null,"This has several consequences however:"),Object(r.b)("ul",null,Object(r.b)("li",{parentName:"ul"},"reactive drivers to databases are bad at relations, which is why the\ndatabase is de-normalized in several ways, attempts to re-normalize the\nschema will involve performance costs, and need for way more requests\nto the database,"),Object(r.b)("li",{parentName:"ul"},"there is a clean border between the domain layer and the data access layer,\nmeaning that there is a need for mapping domain entities to\ndatabase entities.")),Object(r.b)("p",null,"In the database access layer, the objects corresponding to domain entities are\n",Object(r.b)("inlineCode",{parentName:"p"},"BatchEntity"),", ",Object(r.b)("inlineCode",{parentName:"p"},"ExecutionEntity"),", ",Object(r.b)("inlineCode",{parentName:"p"},"StepEntity")," (which is actually part of a JSON\nfield in ",Object(r.b)("inlineCode",{parentName:"p"},"ExecutionEntity"),") and ",Object(r.b)("inlineCode",{parentName:"p"},"OutputFileEntity"),"."),Object(r.b)("h4",{id:"event-handlers"},"Event handlers"),Object(r.b)("p",null,"This adapter uses AMQP event handlers reusing the REGARDS ",Object(r.b)("inlineCode",{parentName:"p"},"IPublisher")," and ",Object(r.b)("inlineCode",{parentName:"p"},"IHandler"),"\ninterfaces. It is reusable as long as the mechanisms behind these interfaces\nare available."),Object(r.b)("h4",{id:"process-management"},"Process management"),Object(r.b)("p",null,"This adapter uses REGARDS plugins as described below. It is not reusable in a\ndifferent context."),Object(r.b)("h4",{id:"workload-engine"},"Workload engine"),Object(r.b)("p",null,"This adapter uses REGARDS jobs as described below. It is not reusable in a\ndifferent context."),Object(r.b)("h3",{id:"order-specific-design-choices"},Object(r.b)("inlineCode",{parentName:"h3"},"Order")," specific design choices"),Object(r.b)("p",null,"The ",Object(r.b)("inlineCode",{parentName:"p"},"Processing")," service has a domain core based on a reactive stack and a\nclean code architecture. This allows the service to be used in many contexts,\nhowever its main use is in conjunction with the ",Object(r.b)("inlineCode",{parentName:"p"},"Order")," service, in the\nREGARDS context, and reusing several REGARDS functionalities. This means that\n",Object(r.b)("inlineCode",{parentName:"p"},"Processing")," is not used in reactive mode, but in servlet mode, in this context."),Object(r.b)("h4",{id:"orderprocessinfo-scope-and-cardinality"},Object(r.b)("inlineCode",{parentName:"h4"},"OrderProcessInfo"),", scope and cardinality"),Object(r.b)("p",null,"A ",Object(r.b)("inlineCode",{parentName:"p"},"PProcess")," provides a metadata key/value store, which provides free information\nto the user. The author of the process can put any useful information for using\nthe process in this metadata."),Object(r.b)("p",null,"In the case of processes used by ",Object(r.b)("inlineCode",{parentName:"p"},"Order"),", this process info is interpreted as\nan ",Object(r.b)("inlineCode",{parentName:"p"},"OrderProcessInfo")," object, containing:"),Object(r.b)("ul",null,Object(r.b)("li",{parentName:"ul"},"limitations on the quantity of data accepted as input,"),Object(r.b)("li",{parentName:"ul"},"the list of required ",Object(r.b)("inlineCode",{parentName:"li"},"DataType")," files (for instance, if a process will be applicable\nonly on ",Object(r.b)("inlineCode",{parentName:"li"},"RAWDATA")," files, this list contains only ",Object(r.b)("inlineCode",{parentName:"li"},"RAWDATA"),"),"),Object(r.b)("li",{parentName:"ul"},"the process size forecast, so that Order can pre-calculate an estimate of\nthe size of the output files"),Object(r.b)("li",{parentName:"ul"},"and two informations we will discuss in more details below: scope and cardinality.")),Object(r.b)("h5",{id:"process-scope"},"Process scope"),Object(r.b)("p",null,"The scope tells how to launch executions in the context of the same suborder."),Object(r.b)("p",null,"The scope can be any of the two following values:"),Object(r.b)("ul",null,Object(r.b)("li",{parentName:"ul"},Object(r.b)("inlineCode",{parentName:"li"},"FEATURE"),": the process is designed to deal with one feature at a time, and thus\nthere will be one execution per feature in the suborder,"),Object(r.b)("li",{parentName:"ul"},Object(r.b)("inlineCode",{parentName:"li"},"SUBORDER"),": the process is designed to deal with several features at a time,\nand there will be only one execution per suborder, with all the features given\nas input.")),Object(r.b)("h5",{id:"process-cardinality"},"Process cardinality"),Object(r.b)("p",null,"The cardinality tells how many output files an execution will generate."),Object(r.b)("p",null,"The cardinality can be any of the following values:"),Object(r.b)("ul",null,Object(r.b)("li",{parentName:"ul"},Object(r.b)("p",{parentName:"li"},Object(r.b)("inlineCode",{parentName:"p"},"ONE_PER_INPUT_FILE"),": the process is designed to produce one output file\nfor each input file."),Object(r.b)("p",{parentName:"li"},"An example of such a process would be a process which produces a companion\nfile for each input file, providing information about the file content,\nits size, etc.")),Object(r.b)("li",{parentName:"ul"},Object(r.b)("p",{parentName:"li"},Object(r.b)("inlineCode",{parentName:"p"},"ONE_PER_FEATURE"),": the process is designed to produce one output file\nfor each feature present in the suborder (this has the same result as\n",Object(r.b)("inlineCode",{parentName:"p"},"ONE_PER_INPUT_FILE")," if there is only one input file per feature, for\ninstance if the process requires only the ",Object(r.b)("inlineCode",{parentName:"p"},"RAWDATA")," files and each feature\nhas only one ",Object(r.b)("inlineCode",{parentName:"p"},"RAWDATA"),"),"),Object(r.b)("p",{parentName:"li"},"An example of such a process would be to create a compressed archive\nfor each feature, each archive containing all the files associated\nto the feature.")),Object(r.b)("li",{parentName:"ul"},Object(r.b)("p",{parentName:"li"},Object(r.b)("inlineCode",{parentName:"p"},"ONE_PER_EXECUTION"),": the process is designed to produce only one output\nfile, no matter what its input is."),Object(r.b)("p",{parentName:"li"},"An example of such a process would be to take several images\nand generate a superposition of all these images, or again producing\na compressed archive of all the files present in the input."))),Object(r.b)("h5",{id:"scopecardinality-couples"},"Scope/cardinality couples"),Object(r.b)("p",null,"Since there are 2 scopes and 3 cardinalities, there are 6 possible\ncombinations, but not all of them are meaningful/useful, and there is\nredundancy."),Object(r.b)("p",null,"For instance, the couples:"),Object(r.b)("ul",null,Object(r.b)("li",{parentName:"ul"},Object(r.b)("inlineCode",{parentName:"li"},"scope=FEATURE cardinality=ONE_PER_FEATURE")," and"),Object(r.b)("li",{parentName:"ul"},Object(r.b)("inlineCode",{parentName:"li"},"scope=FEATURE cardinality=ONE_PER_EXECUTION")," ")),Object(r.b)("p",null,"have the same result: the scope says that there is one execution per feature,\nso they result in the same behaviour."),Object(r.b)("p",null,"The other couples are:"),Object(r.b)("ul",null,Object(r.b)("li",{parentName:"ul"},Object(r.b)("inlineCode",{parentName:"li"},"scope=FEATURE cardinality=ONE_PER_INPUT_FILE"),", which may often also\nhave the same behaviour as the couple above, if there is only one file\nprovided as input for each feature (which may be the case if the process\nrequires only the ",Object(r.b)("inlineCode",{parentName:"li"},"RAWDATA")," files as input),"),Object(r.b)("li",{parentName:"ul"},Object(r.b)("inlineCode",{parentName:"li"},"scope=SUBORDER cardinality=ONE_PER_FEATURE")," is useful if the process\nis designed to treat features independently but has better performances\nwhen grouping several executions, for instance because it has a big\noverhead in its initialization,"),Object(r.b)("li",{parentName:"ul"},Object(r.b)("inlineCode",{parentName:"li"},"scope=SUBORDER cardinality=ONE_PER_INPUT_FILE")," is useful in the same\ncases, but now there are several files per feature and they are treated\nindependently, "),Object(r.b)("li",{parentName:"ul"},Object(r.b)("inlineCode",{parentName:"li"},"scope=SUBORDER cardinality=ONE_PER_EXECUTION")," is useful if the process\nis designed to aggregate information from several features ; however there\nis for now no possibility to group features according to criteria in the\nsame suborder, so the process must accept any group of features.")),Object(r.b)("h4",{id:"general-algorithm-of-orderprocessing-interaction"},"General algorithm of Order/Processing interaction"),Object(r.b)("p",null,"Here is a description of the way ",Object(r.b)("inlineCode",{parentName:"p"},"Order")," and ",Object(r.b)("inlineCode",{parentName:"p"},"Processing")," interact, leaving the\ndetails of the ",Object(r.b)("inlineCode",{parentName:"p"},"Processing")," inner working out of the picture for more clarity."),Object(r.b)("p",null,Object(r.b)("img",{alt:"Order and Processing interaction",src:n(2728).default})),Object(r.b)("h4",{id:"process-definitions-are-regards-plugins"},"Process definitions are REGARDS Plugins"),Object(r.b)("p",null,"In the context of the ",Object(r.b)("inlineCode",{parentName:"p"},"Processing")," service deployed in REGARDS along with the\n",Object(r.b)("inlineCode",{parentName:"p"},"Order")," service, where processes are used to post-process entity feature files,\nprocesses are defined as REGARDS plugins, implementing the ",Object(r.b)("inlineCode",{parentName:"p"},"IProcessDefinition"),"\ninterface."),Object(r.b)("p",null,"These plugins need some configuration:"),Object(r.b)("ul",null,Object(r.b)("li",{parentName:"ul"},"allowed dataset for a process"),Object(r.b)("li",{parentName:"ul"},"allowed user role to use a process")),Object(r.b)("p",null,"This extra information is stored in database as a wrapper for\n",Object(r.b)("inlineCode",{parentName:"p"},"PluginConfiguration")," named ",Object(r.b)("inlineCode",{parentName:"p"},"RightsPluginConfiguration"),". There is a specific\nREST API for interacting with these wrappers, which are used by the\nadministrator."),Object(r.b)("h4",{id:"workload-engine-uses-regards-jobs"},"Workload engine uses REGARDS Jobs"),Object(r.b)("p",null,"The provided workload engine uses the REGARDS jobs mechanism. When the workload\nengine is given an executable, it creates a QUEUED job for execution as soon\nas possible."),Object(r.b)("p",null,"By setting the ",Object(r.b)("inlineCode",{parentName:"p"},"regards.jobs.pool.size")," property, we can limit the number\nof jobs running in parallel, and thus the number of process executions. This limits\nthe overall number of jobs, however, and thus does not permit to limit the number\nof executions ",Object(r.b)("em",{parentName:"p"},"per process"),"."),Object(r.b)("h2",{id:"configuration"},"Configuration"),Object(r.b)("p",null,"The ",Object(r.b)("inlineCode",{parentName:"p"},"Processing")," service can be specifically configured with the following properties:"),Object(r.b)("ul",null,Object(r.b)("li",{parentName:"ul"},Object(r.b)("p",{parentName:"li"},Object(r.b)("inlineCode",{parentName:"p"},"regards.processing.sharedStorage.basePath"),":"),Object(r.b)("p",{parentName:"li"}," Path to a shared storage for processes which need it to store output files."),Object(r.b)("p",{parentName:"li"}," A process may be programmed to create output files anywhere accessible by an URL,\nbut the ",Object(r.b)("inlineCode",{parentName:"p"},"Processing")," service provides as a convenience a shared storage accessible\nto all REGARDS modules needing to access output files, as a mount point in the\nfile system. This way, output files can be passed as ",Object(r.b)("inlineCode",{parentName:"p"},"file")," protocol URLs.\n")),Object(r.b)("li",{parentName:"ul"},Object(r.b)("p",{parentName:"li"},Object(r.b)("inlineCode",{parentName:"p"},"regards.processing.executionWorkdir.basePath"),":"),Object(r.b)("p",{parentName:"li"}," Path to a file system directory where a folder is created for each execution."),Object(r.b)("p",{parentName:"li"}," For processes which may use them, as a convenience, the ",Object(r.b)("inlineCode",{parentName:"p"},"Processing")," service\nprovides utilities to create execution work directories. These execution workdirs\nare created as file system children of this parameter's value.\n")),Object(r.b)("li",{parentName:"ul"},Object(r.b)("p",{parentName:"li"},Object(r.b)("inlineCode",{parentName:"p"},"regards.processing.r2dbc.host"),":"),Object(r.b)("p",{parentName:"li"}," Host to connect to the database.\n")),Object(r.b)("li",{parentName:"ul"},Object(r.b)("p",{parentName:"li"},Object(r.b)("inlineCode",{parentName:"p"},"regards.processing.r2dbc.port"),":"),Object(r.b)("p",{parentName:"li"}," Port to connect to the database.\n")),Object(r.b)("li",{parentName:"ul"},Object(r.b)("p",{parentName:"li"},Object(r.b)("inlineCode",{parentName:"p"},"regards.processing.r2dbc.username"),":"),Object(r.b)("p",{parentName:"li"}," Username to connect to the database.\n")),Object(r.b)("li",{parentName:"ul"},Object(r.b)("p",{parentName:"li"},Object(r.b)("inlineCode",{parentName:"p"},"regards.processing.r2dbc.password"),":"),Object(r.b)("p",{parentName:"li"}," Password to connect to the database.\n")),Object(r.b)("li",{parentName:"ul"},Object(r.b)("p",{parentName:"li"},Object(r.b)("inlineCode",{parentName:"p"},"regards.processing.r2dbc.dbname"),":"),Object(r.b)("p",{parentName:"li"}," Name of the database to connect to.\n")),Object(r.b)("li",{parentName:"ul"},Object(r.b)("p",{parentName:"li"},Object(r.b)("inlineCode",{parentName:"p"},"regards.processing.r2dbc.schema"),":"),Object(r.b)("p",{parentName:"li"}," Schema of the database to connect to.\n")),Object(r.b)("li",{parentName:"ul"},Object(r.b)("p",{parentName:"li"},Object(r.b)("inlineCode",{parentName:"p"},"regards.processing.outputfiles.cleanup.cron"),":"),Object(r.b)("p",{parentName:"li"}," Cron expression to look for downloaded output files and delete them."),Object(r.b)("p",{parentName:"li"}," Output files saved in the storage are cleaned up regularly.\nThis cron expression defines how often.\n")),Object(r.b)("li",{parentName:"ul"},Object(r.b)("p",{parentName:"li"},Object(r.b)("inlineCode",{parentName:"p"},"regards.processing.executions.timedout.cleanup.cron"),":"),Object(r.b)("p",{parentName:"li"}," Cron expression to look for timed out executions."),Object(r.b)("p",{parentName:"li"}," When an execution is created, we use the duration forecast\nof its parent process to determine an expected runtime duration.\nThis time is multiplied by two and saved in base.\nAt every trigger of this cron expression, we look for executions\nthat are still running after this saved duration, and declare\nthem as timed out. This puts them in a final state and notifies\nthe user of the time out. Users may choose to retry.\n")),Object(r.b)("li",{parentName:"ul"},Object(r.b)("p",{parentName:"li"},Object(r.b)("inlineCode",{parentName:"p"},"regards.processing.cleanup.batch.age.ms"),":"),Object(r.b)("p",{parentName:"li"}," Minimum for old terminated batches selected for suppression."),Object(r.b)("p",{parentName:"li"}," Old batches, for which all executions are in a final state, are\nregularly cleaned up. This property say how much time after the last\nexecution's last update a batch is considered too old and\nis selected for deletion.")),Object(r.b)("li",{parentName:"ul"},Object(r.b)("p",{parentName:"li"},Object(r.b)("inlineCode",{parentName:"p"},"regards.processing.cleanup.batch.rate.ms"),":"),Object(r.b)("p",{parentName:"li"}," How often we look for old batches to delete them."))),Object(r.b)("h2",{id:"available-apis"},"Available APIs"),Object(r.b)("ul",null,Object(r.b)("li",{parentName:"ul"},Object(r.b)("a",{parentName:"li",href:"api/process"},"Process")," : API to list/find existing processes"),Object(r.b)("li",{parentName:"ul"},Object(r.b)("a",{parentName:"li",href:"api/batch"},"Batch")," : API to create batches"),Object(r.b)("li",{parentName:"ul"},Object(r.b)("a",{parentName:"li",href:"api/monitoring"},"Monitoring")," : API to monitor existing executions"),Object(r.b)("li",{parentName:"ul"},Object(r.b)("a",{parentName:"li",href:"plugins"},"Rights Plugin Configurations")," : API to manage processes as plugins")))}b.isMDXComponent=!0}}]);